-- ============================================
-- EDUQUIZ - SCHEMA SQL COMPLETO
-- Para PostgreSQL / Supabase
-- ============================================

-- ExtensÃµes necessÃ¡rias
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ============================================
-- TABELA: users (usuÃ¡rios do sistema)
-- ============================================
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    name VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL CHECK (role IN ('student', 'parent', 'teacher', 'admin')),
    avatar_url TEXT,
    is_active BOOLEAN DEFAULT true,
    email_verified BOOLEAN DEFAULT false,
    last_login TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Ãndices para performance
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);

-- ============================================
-- TABELA: students (alunos)
-- ============================================
CREATE TABLE students (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    grade INTEGER NOT NULL CHECK (grade >= 1 AND grade <= 12),
    school VARCHAR(255),
    total_points INTEGER DEFAULT 0,
    level INTEGER DEFAULT 1,
    study_time_seconds INTEGER DEFAULT 0,
    streak_days INTEGER DEFAULT 0,
    last_activity TIMESTAMP WITH TIME ZONE,
    preferences JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_students_user_id ON students(user_id);
CREATE INDEX idx_students_grade ON students(grade);

-- ============================================
-- TABELA: parents (pais/responsÃ¡veis)
-- ============================================
CREATE TABLE parents (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    phone VARCHAR(20),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ============================================
-- TABELA: parent_student_relation (relaÃ§Ã£o pais-filhos)
-- ============================================
CREATE TABLE parent_student_relation (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    parent_id UUID REFERENCES parents(id) ON DELETE CASCADE,
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    relationship VARCHAR(50) NOT NULL, -- 'pai', 'mÃ£e', 'responsÃ¡vel'
    can_view_reports BOOLEAN DEFAULT true,
    can_set_goals BOOLEAN DEFAULT true,
    can_limit_time BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(parent_id, student_id)
);

CREATE INDEX idx_parent_student_parent ON parent_student_relation(parent_id);
CREATE INDEX idx_parent_student_student ON parent_student_relation(student_id);

-- ============================================
-- TABELA: teachers (professores)
-- ============================================
CREATE TABLE teachers (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    specialization TEXT[], -- array de matÃ©rias
    school VARCHAR(255),
    bio TEXT,
    is_verified BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_teachers_user_id ON teachers(user_id);

-- ============================================
-- TABELA: subjects (matÃ©rias)
-- ============================================
CREATE TABLE subjects (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(100) NOT NULL,
    icon VARCHAR(10), -- emoji
    color VARCHAR(50), -- classe CSS ou hex
    description TEXT,
    grade_levels INTEGER[], -- [6,7,8,9]
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_subjects_name ON subjects(name);

-- Inserir matÃ©rias padrÃ£o
INSERT INTO subjects (name, icon, color, grade_levels) VALUES
('MatemÃ¡tica', 'ðŸ“', 'bg-blue-500', ARRAY[6,7,8,9]),
('PortuguÃªs', 'ðŸ“š', 'bg-green-500', ARRAY[6,7,8,9]),
('HistÃ³ria', 'ðŸ›ï¸', 'bg-yellow-500', ARRAY[6,7,8,9]),
('Geografia', 'ðŸŒ', 'bg-purple-500', ARRAY[6,7,8,9]),
('CiÃªncias', 'ðŸ”¬', 'bg-teal-500', ARRAY[6,7,8,9]),
('InglÃªs', 'ðŸ—£ï¸', 'bg-pink-500', ARRAY[6,7,8,9]),
('FÃ­sica', 'âš›ï¸', 'bg-indigo-500', ARRAY[8,9]),
('QuÃ­mica', 'ðŸ§ª', 'bg-orange-500', ARRAY[8,9]);

-- ============================================
-- TABELA: questions (questÃµes)
-- ============================================
CREATE TABLE questions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    subject_id UUID REFERENCES subjects(id) ON DELETE CASCADE,
    teacher_id UUID REFERENCES teachers(id) ON DELETE SET NULL,
    question_text TEXT NOT NULL,
    options JSONB NOT NULL, -- ["opÃ§Ã£o A", "opÃ§Ã£o B", "opÃ§Ã£o C", "opÃ§Ã£o D"]
    correct_answer INTEGER NOT NULL CHECK (correct_answer >= 0 AND correct_answer <= 3),
    explanation TEXT,
    difficulty VARCHAR(20) NOT NULL CHECK (difficulty IN ('easy', 'medium', 'hard')),
    points INTEGER DEFAULT 10,
    grade_level INTEGER NOT NULL,
    tags TEXT[],
    image_url TEXT,
    usage_count INTEGER DEFAULT 0,
    correct_count INTEGER DEFAULT 0,
    incorrect_count INTEGER DEFAULT 0,
    approved BOOLEAN DEFAULT false,
    approved_by UUID REFERENCES teachers(id),
    approved_at TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_questions_subject ON questions(subject_id);
CREATE INDEX idx_questions_teacher ON questions(teacher_id);
CREATE INDEX idx_questions_difficulty ON questions(difficulty);
CREATE INDEX idx_questions_grade ON questions(grade_level);
CREATE INDEX idx_questions_approved ON questions(approved);

-- ============================================
-- TABELA: quizzes (quizzes e provas)
-- ============================================
CREATE TABLE quizzes (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    subject_id UUID REFERENCES subjects(id) ON DELETE CASCADE,
    teacher_id UUID REFERENCES teachers(id) ON DELETE SET NULL,
    grade_level INTEGER NOT NULL,
    type VARCHAR(20) NOT NULL CHECK (type IN ('practice', 'test', 'exam')),
    time_limit_minutes INTEGER,
    total_points INTEGER,
    passing_score INTEGER,
    shuffle_questions BOOLEAN DEFAULT true,
    shuffle_options BOOLEAN DEFAULT true,
    show_explanations BOOLEAN DEFAULT true,
    allow_retries BOOLEAN DEFAULT true,
    max_attempts INTEGER,
    available_from TIMESTAMP WITH TIME ZONE,
    available_until TIMESTAMP WITH TIME ZONE,
    status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'scheduled', 'active', 'ended', 'archived')),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_quizzes_subject ON quizzes(subject_id);
CREATE INDEX idx_quizzes_teacher ON quizzes(teacher_id);
CREATE INDEX idx_quizzes_grade ON quizzes(grade_level);
CREATE INDEX idx_quizzes_status ON quizzes(status);

-- ============================================
-- TABELA: quiz_questions (relaÃ§Ã£o quiz-questÃµes)
-- ============================================
CREATE TABLE quiz_questions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    quiz_id UUID REFERENCES quizzes(id) ON DELETE CASCADE,
    question_id UUID REFERENCES questions(id) ON DELETE CASCADE,
    order_number INTEGER NOT NULL,
    points INTEGER DEFAULT 10,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(quiz_id, question_id)
);

CREATE INDEX idx_quiz_questions_quiz ON quiz_questions(quiz_id);
CREATE INDEX idx_quiz_questions_question ON quiz_questions(question_id);

-- ============================================
-- TABELA: quiz_attempts (tentativas de quiz)
-- ============================================
CREATE TABLE quiz_attempts (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    quiz_id UUID REFERENCES quizzes(id) ON DELETE CASCADE,
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    score INTEGER DEFAULT 0,
    total_points INTEGER NOT NULL,
    correct_answers INTEGER DEFAULT 0,
    total_questions INTEGER NOT NULL,
    percentage DECIMAL(5,2),
    time_spent_seconds INTEGER,
    answers JSONB, -- [{question_id, selected_answer, is_correct, time_spent}]
    started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE,
    status VARCHAR(20) DEFAULT 'in_progress' CHECK (status IN ('in_progress', 'completed', 'abandoned')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_quiz_attempts_quiz ON quiz_attempts(quiz_id);
CREATE INDEX idx_quiz_attempts_student ON quiz_attempts(student_id);
CREATE INDEX idx_quiz_attempts_completed ON quiz_attempts(completed_at);

-- ============================================
-- TABELA: study_sessions (sessÃµes de estudo)
-- ============================================
CREATE TABLE study_sessions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    subject_id UUID REFERENCES subjects(id) ON DELETE SET NULL,
    started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    ended_at TIMESTAMP WITH TIME ZONE,
    duration_seconds INTEGER,
    activities JSONB, -- [{type: 'quiz', id: 'xxx', duration: 300}]
    points_earned INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_study_sessions_student ON study_sessions(student_id);
CREATE INDEX idx_study_sessions_started ON study_sessions(started_at);

-- ============================================
-- TABELA: achievements (conquistas/badges)
-- ============================================
CREATE TABLE achievements (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    icon VARCHAR(10), -- emoji
    category VARCHAR(50), -- 'points', 'streak', 'quizzes', 'time', 'subject'
    condition_type VARCHAR(50) NOT NULL, -- 'points_reached', 'quizzes_completed', 'streak_days', etc
    condition_value INTEGER NOT NULL,
    points_reward INTEGER DEFAULT 0,
    rarity VARCHAR(20) DEFAULT 'common' CHECK (rarity IN ('common', 'rare', 'epic', 'legendary')),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Inserir conquistas padrÃ£o
INSERT INTO achievements (name, description, icon, category, condition_type, condition_value, points_reward, rarity) VALUES
('Iniciante', 'Complete seu primeiro quiz', 'ðŸŽ¯', 'quizzes', 'quizzes_completed', 1, 50, 'common'),
('SequÃªncia de 7', 'Estude 7 dias seguidos', 'ðŸ”¥', 'streak', 'streak_days', 7, 100, 'rare'),
('Perfeccionista', 'Acerte 100% em um quiz', 'â­', 'performance', 'perfect_quiz', 1, 150, 'epic'),
('Estudioso', 'Complete 50 quizzes', 'ðŸ“š', 'quizzes', 'quizzes_completed', 50, 200, 'epic'),
('Mestre', 'Alcance nÃ­vel 10', 'ðŸ†', 'level', 'level_reached', 10, 300, 'legendary'),
('Velocista', 'Responda 10 questÃµes em menos de 5s cada', 'âš¡', 'speed', 'fast_answers', 10, 100, 'rare'),
('Dedicado', 'Estude 10 horas no total', 'ðŸŒŸ', 'time', 'study_hours', 36000, 200, 'epic'),
('MatemÃ¡tico', 'Complete 20 quizzes de MatemÃ¡tica', 'ðŸ”¢', 'subject', 'subject_quizzes', 20, 150, 'rare');

-- ============================================
-- TABELA: student_achievements (conquistas desbloqueadas)
-- ============================================
CREATE TABLE student_achievements (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    achievement_id UUID REFERENCES achievements(id) ON DELETE CASCADE,
    unlocked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(student_id, achievement_id)
);

CREATE INDEX idx_student_achievements_student ON student_achievements(student_id);
CREATE INDEX idx_student_achievements_achievement ON student_achievements(achievement_id);

-- ============================================
-- TABELA: study_plans (planos de estudo)
-- ============================================
CREATE TABLE study_plans (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    created_by UUID REFERENCES users(id), -- pode ser o prÃ³prio aluno ou pai
    subject_id UUID REFERENCES subjects(id) ON DELETE CASCADE,
    goal_description TEXT,
    daily_time_goal_minutes INTEGER,
    weekly_quizzes_goal INTEGER,
    start_date DATE NOT NULL,
    end_date DATE,
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'completed', 'cancelled', 'paused')),
    progress JSONB, -- {completed_days: [], total_time: 0, completed_quizzes: 0}
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_study_plans_student ON study_plans(student_id);
CREATE INDEX idx_study_plans_status ON study_plans(status);

-- ============================================
-- TABELA: notifications (notificaÃ§Ãµes)
-- ============================================
CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    type VARCHAR(50) NOT NULL, -- 'achievement', 'quiz_available', 'goal_reached', 'message', etc
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    link TEXT,
    metadata JSONB,
    is_read BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_notifications_user ON notifications(user_id);
CREATE INDEX idx_notifications_read ON notifications(is_read);
CREATE INDEX idx_notifications_created ON notifications(created_at);

-- ============================================
-- TABELA: messages (mensagens entre usuÃ¡rios)
-- ============================================
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    from_user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    to_user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    subject VARCHAR(255),
    message TEXT NOT NULL,
    is_read BOOLEAN DEFAULT false,
    read_at TIMESTAMP WITH TIME ZONE,
    parent_message_id UUID REFERENCES messages(id), -- para threads
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_messages_from ON messages(from_user_id);
CREATE INDEX idx_messages_to ON messages(to_user_id);
CREATE INDEX idx_messages_read ON messages(is_read);

-- ============================================
-- TABELA: parental_controls (controle parental)
-- ============================================
CREATE TABLE parental_controls (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    parent_id UUID REFERENCES parents(id) ON DELETE CASCADE,
    max_daily_time_minutes INTEGER,
    allowed_start_time TIME,
    allowed_end_time TIME,
    blocked_subjects UUID[],
    require_approval_for_new_content BOOLEAN DEFAULT false,
    notifications_enabled BOOLEAN DEFAULT true,
    weekly_report_enabled BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(student_id, parent_id)
);

CREATE INDEX idx_parental_controls_student ON parental_controls(student_id);

-- ============================================
-- TABELA: analytics_events (eventos para analytics)
-- ============================================
CREATE TABLE analytics_events (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    event_type VARCHAR(100) NOT NULL,
    event_data JSONB,
    session_id VARCHAR(255),
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_analytics_user ON analytics_events(user_id);
CREATE INDEX idx_analytics_type ON analytics_events(event_type);
CREATE INDEX idx_analytics_created ON analytics_events(created_at);

-- ============================================
-- FUNÃ‡Ã•ES E TRIGGERS
-- ============================================

-- FunÃ§Ã£o para atualizar updated_at automaticamente
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Aplicar trigger em tabelas relevantes
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_students_updated_at BEFORE UPDATE ON students
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_questions_updated_at BEFORE UPDATE ON questions
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_quizzes_updated_at BEFORE UPDATE ON quizzes
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_study_plans_updated_at BEFORE UPDATE ON study_plans
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- FunÃ§Ã£o para calcular porcentagem do quiz
CREATE OR REPLACE FUNCTION calculate_quiz_percentage()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.completed_at IS NOT NULL THEN
        NEW.percentage = (NEW.score::DECIMAL / NEW.total_points::DECIMAL) * 100;
    END IF;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER calculate_quiz_attempts_percentage BEFORE UPDATE ON quiz_attempts
    FOR EACH ROW EXECUTE FUNCTION calculate_quiz_percentage();

-- FunÃ§Ã£o para atualizar estatÃ­sticas da questÃ£o
CREATE OR REPLACE FUNCTION update_question_stats()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.completed_at IS NOT NULL AND OLD.completed_at IS NULL THEN
        -- Quiz foi completado, atualizar estatÃ­sticas das questÃµes
        UPDATE questions q
        SET 
            usage_count = usage_count + 1,
            correct_count = correct_count + (
                SELECT COUNT(*)
                FROM jsonb_array_elements(NEW.answers) AS answer
                WHERE (answer->>'question_id')::UUID = q.id
                AND (answer->>'is_correct')::BOOLEAN = true
            ),
            incorrect_count = incorrect_count + (
                SELECT COUNT(*)
                FROM jsonb_array_elements(NEW.answers) AS answer
                WHERE (answer->>'question_id')::UUID = q.id
                AND (answer->>'is_correct')::BOOLEAN = false
            )
        WHERE q.id IN (
            SELECT (answer->>'question_id')::UUID
            FROM jsonb_array_elements(NEW.answers) AS answer
        );
    END IF;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_question_stats_trigger AFTER UPDATE ON quiz_attempts
    FOR EACH ROW EXECUTE FUNCTION update_question_stats();

-- ============================================
-- VIEWS ÃšTEIS
-- ============================================

-- View: EstatÃ­sticas dos alunos
CREATE OR REPLACE VIEW student_stats AS
SELECT 
    s.id,
    s.user_id,
    u.name,
    s.grade,
    s.total_points,
    s.level,
    s.study_time_seconds,
    s.streak_days,
    COUNT(DISTINCT qa.id) as total_quizzes,
    ROUND(AVG(qa.percentage), 2) as avg_score,
    COUNT(DISTINCT sa.achievement_id) as achievements_count
FROM students s
JOIN users u ON s.user_id = u.id
LEFT JOIN quiz_attempts qa ON s.id = qa.student_id AND qa.status = 'completed'
LEFT JOIN student_achievements sa ON s.id = sa.student_id
GROUP BY s.id, u.name;

-- View: Desempenho por matÃ©ria
CREATE OR REPLACE VIEW student_subject_performance AS
SELECT 
    s.id as student_id,
    subj.id as subject_id,
    subj.name as subject_name,
    COUNT(qa.id) as quizzes_completed,
    ROUND(AVG(qa.percentage), 2) as avg_score,
    SUM(qa.score) as total_points
FROM students s
CROSS JOIN subjects subj
LEFT JOIN quiz_attempts qa ON s.id = qa.student_id 
    AND qa.status = 'completed'
LEFT JOIN quizzes q ON qa.quiz_id = q.id AND q.subject_id = subj.id
GROUP BY s.id, subj.id, subj.name;

-- View: Ranking geral
CREATE OR REPLACE VIEW leaderboard AS
SELECT 
    s.id,
    u.name,
    s.grade,
    s.total_points,
    s.level,
    RANK() OVER (ORDER BY s.total_points DESC) as rank,
    RANK() OVER (PARTITION BY s.grade ORDER BY s.total_points DESC) as rank_in_grade
FROM students s
JOIN users u ON s.user_id = u.id
WHERE u.is_active = true;

-- ============================================
-- POLICIES (RLS - Row Level Security)
-- Para Supabase - Descomentar se usar
-- ============================================

-- ALTER TABLE users ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE students ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE questions ENABLE ROW LEVEL SECURITY;
-- etc...

-- Exemplo de policy:
-- CREATE POLICY "Users can view own data" ON users
--     FOR SELECT USING (auth.uid() = id);

-- ============================================
-- DADOS DE TESTE (SEED)
-- ============================================

-- UsuÃ¡rio admin de teste
INSERT INTO users (email, password_hash, name, role, email_verified) VALUES
('admin@eduquiz.com', crypt('admin123', gen_salt('bf')), 'Administrador', 'admin', true);

-- Professor de teste
INSERT INTO users (email, password_hash, name, role, email_verified) VALUES
('prof.carlos@escola.com', crypt('prof123', gen_salt('bf')), 'Prof. Carlos Silva', 'teacher', true);

INSERT INTO teachers (user_id, specialization, school, bio) VALUES
((SELECT id FROM users WHERE email = 'prof.carlos@escola.com'), 
 ARRAY['MatemÃ¡tica', 'FÃ­sica'], 
 'ColÃ©gio Exemplo', 
 'Professor com 10 anos de experiÃªncia');

-- ============================================
-- FIM DO SCHEMA
-- ============================================

-- Para executar este script no Supabase:
-- 1. VÃ¡ em "SQL Editor"
-- 2. Cole este cÃ³digo
-- 3. Clique em "Run"
-- 4. Aguarde a execuÃ§Ã£o completa

-- Para backup:
-- pg_dump -h sua-url.supabase.co -U postgres -d postgres --schema-only > schema.sql