EduQuiz Backend - Arquivos Finais e Guia de InstalaÃ§Ã£o

ğŸ“ Estrutura Completa do Projeto

eduquiz-backend/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ database.js
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ auth.js
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ auth.js
â”‚   â”œâ”€â”€ students.js
â”‚   â”œâ”€â”€ parents.js
â”‚   â”œâ”€â”€ teachers.js
â”‚   â”œâ”€â”€ questions.js
â”‚   â”œâ”€â”€ quizzes.js
â”‚   â”œâ”€â”€ subjects.js
â”‚   â”œâ”€â”€ achievements.js
â”‚   â””â”€â”€ notifications.js
â”œâ”€â”€ uploads/
â”œâ”€â”€ .env
â”œâ”€â”€ .env.example
â”œâ”€â”€ .gitignore
â”œâ”€â”€ package.json
â””â”€â”€ server.js

ğŸ“„ Arquivos Restantes

11. routes/subjects.js

const express = require('express');
const router = express.Router();
const { query } = require('../config/database');
const { authenticateToken } = require('../middleware/auth');

// Listar todas as matÃ©rias
router.get('/', authenticateToken, async (req, res) => {
  try {
    const result = await query(
      'SELECT * FROM subjects WHERE is_active = true ORDER BY name'
    );

    res.json({ subjects: result.rows });
  } catch (err) {
    console.error('Erro ao listar matÃ©rias:', err);
    res.status(500).json({ error: 'Erro ao listar matÃ©rias' });
  }
});

// Buscar questÃµes de uma matÃ©ria
router.get('/:id/questions', authenticateToken, async (req, res) => {
  const { id } = req.params;
  const { grade_level, difficulty, limit = 20 } = req.query;

  try {
    let queryText = `
      SELECT * FROM questions 
      WHERE subject_id = $1 AND is_active = true AND approved = true
    `;
    const params = [id];
    let paramCount = 1;

    if (grade_level) {
      paramCount++;
      queryText += ` AND grade_level = $${paramCount}`;
      params.push(grade_level);
    }

    if (difficulty) {
      paramCount++;
      queryText += ` AND difficulty = $${paramCount}`;
      params.push(difficulty);
    }

    queryText += ` ORDER BY RANDOM() LIMIT $${paramCount + 1}`;
    params.push(limit);

    const result = await query(queryText, params);

    res.json({ questions: result.rows });
  } catch (err) {
    console.error('Erro ao buscar questÃµes:', err);
    res.status(500).json({ error: 'Erro ao buscar questÃµes' });
  }
});

module.exports = router;

12. routes/teachers.js

const express = require('express');
const router = express.Router();
const { query } = require('../config/database');
const { authenticateToken, authorizeRoles } = require('../middleware/auth');

// Get teacher dashboard stats
router.get('/:id/dashboard', 
  authenticateToken, 
  authorizeRoles('teacher'),
  async (req, res) => {
    const { id } = req.params;

    try {
      // Buscar teacher_id
      const teacherResult = await query(
        'SELECT id FROM teachers WHERE user_id = $1',
        [req.user.id]
      );

      if (teacherResult.rows.length === 0) {
        return res.status(404).json({ error: 'Professor nÃ£o encontrado' });
      }

      const teacherId = teacherResult.rows[0].id;

      // EstatÃ­sticas
      const stats = await query(
        `SELECT 
          (SELECT COUNT(*) FROM questions WHERE teacher_id = $1 AND is_active = true) as questions_created,
          (SELECT COUNT(*) FROM quizzes WHERE teacher_id = $1 AND is_active = true) as quizzes_created,
          (SELECT COUNT(DISTINCT qa.student_id) 
           FROM quiz_attempts qa 
           JOIN quizzes q ON qa.quiz_id = q.id 
           WHERE q.teacher_id = $1) as active_students,
          (SELECT ROUND(AVG(qa.percentage), 2)
           FROM quiz_attempts qa 
           JOIN quizzes q ON qa.quiz_id = q.id 
           WHERE q.teacher_id = $1 AND qa.status = 'completed') as avg_class_score`,
        [teacherId]
      );

      // QuestÃµes mais difÃ­ceis
      const difficultQuestions = await query(
        `SELECT 
          q.id,
          q.question_text,
          q.difficulty,
          ROUND((q.correct_count::DECIMAL / NULLIF(q.usage_count, 0)) * 100, 2) as success_rate
         FROM questions q
         WHERE q.teacher_id = $1 AND q.usage_count > 5
         ORDER BY success_rate ASC
         LIMIT 5`,
        [teacherId]
      );

      // Alunos que precisam de atenÃ§Ã£o
      const studentsNeedingHelp = await query(
        `SELECT 
          s.id,
          u.name,
          s.grade,
          ROUND(AVG(qa.percentage), 2) as avg_score,
          COUNT(qa.id) as quizzes_completed
         FROM students s
         JOIN users u ON s.user_id = u.id
         JOIN quiz_attempts qa ON s.id = qa.student_id
         JOIN quizzes q ON qa.quiz_id = q.id
         WHERE q.teacher_id = $1 
           AND qa.status = 'completed'
           AND qa.completed_at >= NOW() - INTERVAL '30 days'
         GROUP BY s.id, u.name, s.grade
         HAVING ROUND(AVG(qa.percentage), 2) < 70
         ORDER BY avg_score ASC
         LIMIT 10`,
        [teacherId]
      );

      res.json({
        stats: stats.rows[0],
        difficult_questions: difficultQuestions.rows,
        students_needing_help: studentsNeedingHelp.rows
      });
    } catch (err) {
      console.error('Erro ao buscar dashboard:', err);
      res.status(500).json({ error: 'Erro ao buscar dashboard' });
    }
  }
);

// Get teacher students
router.get('/:id/students',
  authenticateToken,
  authorizeRoles('teacher'),
  async (req, res) => {
    try {
      // Buscar teacher_id
      const teacherResult = await query(
        'SELECT id FROM teachers WHERE user_id = $1',
        [req.user.id]
      );

      const teacherId = teacherResult.rows[0].id;

      // Buscar alunos que fizeram quizzes deste professor
      const result = await query(
        `SELECT DISTINCT
          s.id,
          u.name,
          s.grade,
          s.total_points,
          COUNT(DISTINCT qa.id) as quizzes_completed,
          ROUND(AVG(qa.percentage), 2) as avg_score
         FROM students s
         JOIN users u ON s.user_id = u.id
         JOIN quiz_attempts qa ON s.id = qa.student_id
         JOIN quizzes q ON qa.quiz_id = q.id
         WHERE q.teacher_id = $1 AND qa.status = 'completed'
         GROUP BY s.id, u.name, s.grade, s.total_points
         ORDER BY avg_score DESC`,
        [teacherId]
      );

      res.json({ students: result.rows });
    } catch (err) {
      console.error('Erro ao buscar alunos:', err);
      res.status(500).json({ error: 'Erro ao buscar alunos' });
    }
  }
);

// Bulk import questions (CSV)
router.post('/:id/questions/bulk-import',
  authenticateToken,
  authorizeRoles('teacher'),
  async (req, res) => {
    const { questions } = req.body; // Array de questÃµes

    try {
      // Buscar teacher_id
      const teacherResult = await query(
        'SELECT id FROM teachers WHERE user_id = $1',
        [req.user.id]
      );

      const teacherId = teacherResult.rows[0].id;

      const imported = [];
      
      for (const q of questions) {
        const result = await query(
          `INSERT INTO questions 
          (subject_id, teacher_id, question_text, options, correct_answer, 
           difficulty, grade_level, tags)
          VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
          RETURNING id`,
          [q.subject_id, teacherId, q.question_text, JSON.stringify(q.options),
           q.correct_answer, q.difficulty, q.grade_level, q.tags]
        );
        imported.push(result.rows[0].id);
      }

      res.json({
        message: `${imported.length} questÃµes importadas com sucesso`,
        imported_ids: imported
      });
    } catch (err) {
      console.error('Erro ao importar questÃµes:', err);
      res.status(500).json({ error: 'Erro ao importar questÃµes' });
    }
  }
);

module.exports = router;

13. routes/achievements.js

const express = require('express');
const router = express.Router();
const { query } = require('../config/database');
const { authenticateToken } = require('../middleware/auth');

// Listar todas as conquistas
router.get('/', authenticateToken, async (req, res) => {
  try {
    const result = await query(
      'SELECT * FROM achievements WHERE is_active = true ORDER BY rarity, points_reward DESC'
    );

    res.json({ achievements: result.rows });
  } catch (err) {
    console.error('Erro ao listar conquistas:', err);
    res.status(500).json({ error: 'Erro ao listar conquistas' });
  }
});

// Verificar e desbloquear conquistas para um aluno
router.post('/check/:studentId',
  authenticateToken,
  authorizeRoles('student'),
  async (req, res) => {
    const { studentId } = req.params;

    try {
      // Buscar dados do aluno
      const studentData = await query(
        `SELECT 
          s.*,
          COUNT(DISTINCT qa.id) as total_quizzes,
          COUNT(DISTINCT CASE WHEN qa.percentage = 100 THEN qa.id END) as perfect_quizzes
         FROM students s
         LEFT JOIN quiz_attempts qa ON s.id = qa.student_id AND qa.status = 'completed'
         WHERE s.id = $1
         GROUP BY s.id`,
        [studentId]
      );

      if (studentData.rows.length === 0) {
        return res.status(404).json({ error: 'Aluno nÃ£o encontrado' });
      }

      const student = studentData.rows[0];
      const newAchievements = [];

      // Buscar conquistas ainda nÃ£o desbloqueadas
      const availableAchievements = await query(
        `SELECT a.* FROM achievements a
         WHERE a.is_active = true
         AND a.id NOT IN (
           SELECT achievement_id FROM student_achievements WHERE student_id = $1
         )`,
        [studentId]
      );

      // Verificar cada conquista
      for (const achievement of availableAchievements.rows) {
        let unlocked = false;

        switch (achievement.condition_type) {
          case 'quizzes_completed':
            unlocked = student.total_quizzes >= achievement.condition_value;
            break;
          case 'perfect_quiz':
            unlocked = student.perfect_quizzes >= achievement.condition_value;
            break;
          case 'level_reached':
            unlocked = student.level >= achievement.condition_value;
            break;
          case 'streak_days':
            unlocked = student.streak_days >= achievement.condition_value;
            break;
          case 'study_hours':
            unlocked = student.study_time_seconds >= achievement.condition_value;
            break;
        }

        if (unlocked) {
          // Desbloquear conquista
          await query(
            'INSERT INTO student_achievements (student_id, achievement_id) VALUES ($1, $2)',
            [studentId, achievement.id]
          );

          // Adicionar pontos bÃ´nus
          if (achievement.points_reward > 0) {
            await query(
              'UPDATE students SET total_points = total_points + $1 WHERE id = $2',
              [achievement.points_reward, studentId]
            );
          }

          newAchievements.push(achievement);
        }
      }

      res.json({
        message: `${newAchievements.length} novas conquistas desbloqueadas`,
        new_achievements: newAchievements
      });
    } catch (err) {
      console.error('Erro ao verificar conquistas:', err);
      res.status(500).json({ error: 'Erro ao verificar conquistas' });
    }
  }
);

module.exports = router;

14. routes/notifications.js

const express = require('express');
const router = express.Router();
const { query } = require('../config/database');
const { authenticateToken } = require('../middleware/auth');

// Buscar notificaÃ§Ãµes do usuÃ¡rio
router.get('/', authenticateToken, async (req, res) => {
  const { limit = 20, unread_only = false } = req.query;

  try {
    let queryText = 'SELECT * FROM notifications WHERE user_id = $1';
    const params = [req.user.id];

    if (unread_only === 'true') {
      queryText += ' AND is_read = false';
    }

    queryText += ' ORDER BY created_at DESC LIMIT $2';
    params.push(limit);

    const result = await query(queryText, params);

    res.json({ notifications: result.rows });
  } catch (err) {
    console.error('Erro ao buscar notificaÃ§Ãµes:', err);
    res.status(500).json({ error: 'Erro ao buscar notificaÃ§Ãµes' });
  }
});

// Marcar como lida
router.put('/:id/read', authenticateToken, async (req, res) => {
  const { id } = req.params;

  try {
    const result = await query(
      'UPDATE notifications SET is_read = true WHERE id = $1 AND user_id = $2 RETURNING *',
      [id, req.user.id]
    );

    if (result.rows.length === 0) {
      return res.status(404).json({ error: 'NotificaÃ§Ã£o nÃ£o encontrada' });
    }

    res.json({ notification: result.rows[0] });
  } catch (err) {
    console.error('Erro ao marcar notificaÃ§Ã£o:', err);
    res.status(500).json({ error: 'Erro ao marcar notificaÃ§Ã£o' });
  }
});

// Marcar todas como lidas
router.post('/mark-all-read', authenticateToken, async (req, res) => {
  try {
    await query(
      'UPDATE notifications SET is_read = true WHERE user_id = $1 AND is_read = false',
      [req.user.id]
    );

    res.json({ message: 'Todas as notificaÃ§Ãµes foram marcadas como lidas' });
  } catch (err) {
    console.error('Erro ao marcar notificaÃ§Ãµes:', err);
    res.status(500).json({ error: 'Erro ao marcar notificaÃ§Ãµes' });
  }
});

module.exports = router;

ğŸš€ Guia de InstalaÃ§Ã£o
PrÃ©-requisitos

Node.js 18+ instalado
PostgreSQL 14+ instalado (ou conta no Supabase)
Git

Passo 1: Clonar e Configurar

# Criar pasta do projeto
mkdir eduquiz-backend
cd eduquiz-backend

# Inicializar projeto
npm init -y

# Instalar dependÃªncias
npm install express pg bcrypt jsonwebtoken dotenv cors express-validator express-rate-limit helmet morgan multer nodemailer

# Instalar dependÃªncias de desenvolvimento
npm install --save-dev nodemon

Passo 2: Criar Estrutura de Pastas

mkdir config middleware routes uploads

Passo 3: Criar arquivo .env

# Copiar do .env.example
cp .env.example .env

# Editar .env com suas credenciais
nano .env

Exemplo de .env:

DATABASE_URL=postgresql://postgres:suasenha@localhost:5432/eduquiz
JWT_SECRET=mude_isto_para_algo_super_seguro_e_aleatorio
JWT_EXPIRES_IN=7d
PORT=3001
NODE_ENV=development
FRONTEND_URL=http://localhost:3000

Passo 4: Executar SQL no Banco

# Se usando Supabase:
# 1. VÃ¡ para o SQL Editor
# 2. Cole todo o schema SQL
# 3. Execute

# Se usando PostgreSQL local:
psql -U postgres -d eduquiz -f schema.sql

Passo 5: Criar todos os arquivos
Copie todos os cÃ³digos fornecidos para os respectivos arquivos na estrutura de pastas.
Passo 6: Iniciar o servidor

# Modo desenvolvimento (com auto-reload)
npm run dev

# Modo produÃ§Ã£o
npm start

O servidor estarÃ¡ rodando em http://localhost:3001

ğŸ§ª Testando a API
1. Registro de usuÃ¡rio

curl -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "aluno@teste.com",
    "password": "senha123",
    "name": "Aluno Teste",
    "role": "student",
    "grade": 7
  }'
  
2. Login

curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "aluno@teste.com",
    "password": "senha123"
  }'
  
  Guarde o token retornado!
  
  3. Listar matÃ©rias
  
  curl http://localhost:3001/api/subjects \
  -H "Authorization: Bearer SEU_TOKEN_AQUI"
  
  4. Criar questÃ£o (como professor)
  
  curl -X POST http://localhost:3001/api/questions \
  -H "Authorization: Bearer SEU_TOKEN_AQUI" \
  -H "Content-Type: application/json" \
  -d '{
    "subject_id": "UUID_DA_MATERIA",
    "question_text": "Quanto Ã© 2 + 2?",
    "options": ["3", "4", "5", "6"],
    "correct_answer": 1,
    "difficulty": "easy",
    "grade_level": 6,
    "tags": ["matemÃ¡tica", "soma"]
  }'
  
  ğŸ“¦ Deploy
OpÃ§Ã£o 1: Railway.app (Recomendado)

Crie conta no Railway.app
Clique em "New Project"
Selecione "Deploy from GitHub repo"
Conecte seu repositÃ³rio
Adicione PostgreSQL como serviÃ§o
Configure variÃ¡veis de ambiente
Deploy automÃ¡tico! ğŸš€

OpÃ§Ã£o 2: Render.com

Crie conta no Render.com
New > Web Service
Conecte repositÃ³rio
Configure:

Build Command: npm install
Start Command: npm start


Adicione PostgreSQL
Configure variÃ¡veis de ambiente
Deploy!

OpÃ§Ã£o 3: Heroku

# Instalar Heroku CLI
heroku login
heroku create eduquiz-api

# Adicionar PostgreSQL
heroku addons:create heroku-postgresql:mini

# Deploy
git push heroku main

# Configurar variÃ¡veis
heroku config:set JWT_SECRET=seu_secret
heroku config:set FRONTEND_URL=https://seu-frontend.com

ğŸ“š DocumentaÃ§Ã£o da API
Endpoints Principais
AutenticaÃ§Ã£o

POST /api/auth/register - Registrar usuÃ¡rio
POST /api/auth/login - Login
GET /api/auth/me - Dados do usuÃ¡rio atual

QuestÃµes

GET /api/questions - Listar questÃµes
POST /api/questions - Criar questÃ£o
PUT /api/questions/:id - Atualizar questÃ£o
DELETE /api/questions/:id - Deletar questÃ£o

Quizzes

GET /api/quizzes/available - Quizzes disponÃ­veis
POST /api/quizzes - Criar quiz
POST /api/quizzes/:id/attempt - Iniciar tentativa
POST /api/quizzes/:id/attempt/:attemptId/submit - Submeter respostas

Alunos

GET /api/students/:id/stats - EstatÃ­sticas
GET /api/students/:id/history - HistÃ³rico
GET /api/students/:id/achievements - Conquistas

Pais

GET /api/parents/:id/children - Listar filhos
GET /api/parents/:id/children/:studentId/reports - RelatÃ³rios
POST /api/parents/:id/children/:studentId/goals - Criar meta

Professores

GET /api/teachers/:id/dashboard - Dashboard
GET /api/teachers/:id/students - Alunos
POST /api/teachers/:id/questions/bulk-import - Importar questÃµes


ğŸ”’ SeguranÃ§a

âœ… Senhas hasheadas com bcrypt
âœ… JWT para autenticaÃ§Ã£o
âœ… Rate limiting
âœ… Helmet.js para headers de seguranÃ§a
âœ… ValidaÃ§Ã£o de inputs
âœ… CORS configurado
âœ… SQL injection prevention (parametrized queries)


ğŸ› Troubleshooting
Erro: "Cannot connect to database"

Verifique se PostgreSQL estÃ¡ rodando
Confira o DATABASE_URL no .env
Teste conexÃ£o: psql -U postgres

Erro: "JWT secret not defined"

Configure JWT_SECRET no .env
Reinicie o servidor

Erro: "Port 3001 already in use"

Mude a porta no .env: PORT=3002
Ou mate o processo: kill -9 $(lsof -ti:3001)


ğŸ“ Suporte
DÃºvidas? Problemas? Estou aqui para ajudar! ğŸš€


